/**
 * jQuery Ansel
 * Author: Crowd Favorite <http://crowdfavorite.com/>
 * Location: http://github.com/crowdfavorite/jquery-ansel
 * Version: 0.2
 *
 * This plugin provides backward-compatible image cropping and zooming functionality for a variety of browser to be allowed to pan and zoom images in order to select a cropped area for submission.
 * A live preview is provided and, where possible, the only data submission for the image is the cropped, panned, and zoomed section of the image. File API still currently required.
 */
if(jQuery){(function(e){e.fn.extend({ansel:function(){var t=this,n=Array.prototype.slice.call(arguments),r=t.data("AnselEditor");if(r===undefined){r=function(){var r,i;if(n.length===1&&typeof n[0]=="object"){i=n[0]}else{i={}}r=function(n){var r,s,o,u,a=function(){var e=document.createElement("canvas");return{canvas:!!(e.getContext&&e.getContext("2d")),fileapi:!!(t.get(0).files&&FileReader&&File)}}();n=e.extend({size:[100,100],container:t.parent(),moveable:true,"scale-output":1,zoom:true,overrideHandlers:false},n);r=function(e,n,r){var i=new Image,s=0,o=0,u=0,a=0,f=0,l=0,c=1,h=1,p=1,r=!!r;this.scale=function(e){if(typeof e!=="undefined"){if(e<h){c=h}else if(e>p){c=p}else{c=e}s=f*c;o=l*c;if(!r){t.trigger("ansel-scale-set",c)}}return c};this.minScale=function(e){if(typeof e!=="undefined"){h=e;t.trigger("ansel-min-scale-set",h);if(h>p){p=e}if(h>c){this.scale(h)}}return h};this.maxScale=function(e){if(typeof e!=="undefined"){p=e;t.trigger("ansel-max-scale-set",p);if(p<h){h=p}if(p<c){this.scale(p)}}return p};this.position=function(e){if(typeof e!=="undefined"&&typeof e.x!=="undefined"&&typeof e.y!=="undefined"){u=e.x;a=e.y}return{x:u,y:a}};this.size=function(){return{width:o,height:s}};this.originalSize=function(){return{width:l,height:f}};this.element=function(){return i};i.onload=function(e){return function(){var t=this;f=t.height;l=t.width;e.minScale(1);e.maxScale(1);e.scale(1);e.position({x:0,y:0});n(e)}}(this);i.src=e};s=function(n,i,s){var o,u;if(a.canvas){u=e("<canvas></canvas>")}else{u=e("<div></div>")}u.css({width:n[0]+"px",height:n[1]+"px",overflow:"hidden"}).attr({width:n[0],height:n[1]}).addClass("ansel-stage");if(typeof i!==null){u.appendTo(i)}u=u.get(0);this.suppressTriggers=!!s;this.actor=function(){return o};this.size=function(){return{width:u.offsetWidth,height:u.offsetHeight}};this.addImage=function(e,n){var i=function(e){return function(r){o=r;e.reset();if(!e.suppressTriggers){t.trigger("ansel-image-loaded")}if(typeof n==="function"){n()}}}(this);new r(e,i,this.suppressTriggers)};this.element=function(){return u};this.minScale=function(e){var n=this.actor(),r;if(typeof n!=="undefined"){r=n.minScale(e);if(typeof e!=="undefined"){return t}else{return r}}return t};this.maxScale=function(e){var n=this.actor(),r;if(typeof n!=="undefined"){r=n.maxScale(e);if(typeof e!=="undefined"){return t}else{return r}}return t};this.clear()};e.extend(s.prototype,{clear:function(){var n=this.element(),r=e(n);if(a.canvas){(function(e){var t=n.getContext("2d");t.clearRect(0,0,e.offsetWidth,e.offsetHeight)})(this)}else{r.html("")}if(!this.suppressTriggers){t.trigger("ansel-cleared")}},reset:function(){var n=this.actor(),r=this.size(),i=r.width/r.height,s=n.size(),o=n.originalSize(),u=s.width/s.height,a=1;element=this.element(),$element=e(element);if(u>=i){a=element.offsetHeight/o.height}else{a=element.offsetWidth/o.width}this.minScale(a);this.maxScale(a*4);this.scale(a);s=n.size();n.position({x:(element.offsetWidth-s.width)/2,y:(element.offsetHeight-s.height)/2});this.draw();if(!this.suppressTriggers){t.trigger("ansel-reset")}},draw:function(){var n=this.actor(),r=this.element(),i,s,o=n.element();if(typeof n=="undefined"||!n){return}this.clear();i=n.size();s=n.position();if(a.canvas){(function(){var e=r.getContext("2d");e.drawImage(o,s.x,s.y,i.width,i.height)})()}else{(function(){e(o).css({left:s.x+"px",top:s.y+"px",width:i.width+"px",height:i.height+"px",position:"absolute"}).appendTo(r)})()}if(!this.suppressTriggers){t.trigger("ansel-drawn")}},scale:function(n,r){var i=this.actor(),s,o,u,a,f,l;if(typeof n!=="undefined"){if(typeof i!=="undefined"){o=i.position();u=i.size();i.scale(n);a=i.size();if(typeof r==="undefined"||typeof r.x==="undefined"||typeof r.y==="undefined"){r={x:e(this.element()).width()/2,y:e(this.element()).height()/2}}f=(r.x-o.x)/u.width;l=(r.y-o.y)/u.height;o.x=(u.width-a.width)*f;o.y=(u.height-a.height)*l;this.move(o);this.draw();if(!this.suppressTriggers){t.trigger("ansel-scale-set",n)}}return t}else if(typeof i!=="undefined"){return i.scale()}return t},position:function(e){var t=this.actor();if(typeof t!=="undefined"){return this.actor().position(e)}else{return false}},move:function(e){var n=this.actor();if(typeof e.x!=="undefined"&&typeof e.y!=="undefined"){if(typeof n!=="undefined"){(function(r){var i=n.position(),s=n.size(),o=r.size(),u={x:i.x+e.x,y:i.y+e.y};if(u.x>0){u.x=0}else if(u.x+s.width<o.width){u.x=o.width-s.width}if(u.y>0){u.y=0}else if(u.y+s.height<o.height){u.y=o.height-s.height}n.position(u);if(!this.suppressTriggers){t.trigger("ansel-position-set",u)}r.draw()})(this)}}return t},"export":function(n,r){var i={};if(typeof n!=="undefined"){i.outputscale=n}else{i.outputscale=1}if(i.outputscale===1){if(a.canvas){i.local=true;i.image=this.element().toDataURL();i.position={x:0,y:0};i.zoom=1;i.size=this.size()}else{i.local=false;i.image=t.attr("name");i.zoom=this.scale();i.position=this.position();i.size=this.size()}if(typeof r!=="undefined"){r(i)}else{t.trigger("ansel-export",i)}}else{(function(n){var o=n.size(),u,f,l;u=[o.width*i.outputscale,o.height*i.outputscale];newStage=new s(u,null,true);f=e(newStage.element()).css({position:"absolute",left:"-1000000000px",top:"-1000000000px"});f.appendTo(e("body"));l=function(){var e=n.position();e.x=e.x*i.outputscale;e.y=e.y*i.outputscale;newStage.scale(n.scale()*i.outputscale);newStage.position(e);newStage.draw();if(a.canvas){i.local=true;i.image=newStage.element().toDataURL();i.position={x:0,y:0};i.size=newStage.size();i.zoom=1}else{i.local=false;i.image=t.attr("name");i.zoom=newStage.scale();i.size=newStage.size();i.position=newStage.position()}f.remove();if(typeof r!=="undefined"){r(i)}else{t.trigger("ansel-export",i)}};newStage.addImage(e(n.actor().element()).attr("src"),l)})(this)}}});o=function(){var t,r=e('<div class="ansel"></div>').css({position:"relative",overflow:"hidden"}),i=1;r=r.appendTo(n.container).get(0);t=new s(n.size,r);this.stage=function(){return t};this.element=function(){return r}};u=new o;this.loadImage=function(e){u.stage().addImage(imageUrl)};this.scale=function(e){var r=u.stage(),i,s;if(typeof r!=="undefined"){if(e.length>1){s=e[1]}if(e.length>0){i=e[0]}if(!n.zoom){return r.scale()}return r.scale(i,s)}return t};this.minscale=function(e){var r=u.stage(),i;if(typeof r!=="undefined"){if(e.length>0){i=e[0]}if(!n.zoom){return r.scale()}return r.minScale(i)}return t};this.maxscale=function(e){var r=u.stage(),i;if(typeof r!=="undefined"){if(e.length>0){i=e[0]}if(!n.zoom){return r.scale()}return r.maxScale(i)}return t};this.move=function(e){var r=u.stage(),i;if(typeof r!=="undefined"&&n.moveable){if(typeof e=="object"&&typeof e.x!=="undefined"&&typeof e.y!=="undefined"){i={x:e.x,y:e.y}}else if(e.length>1){i={x:e[0],y:e[1]}}else if(e.length>0){i=e[0]}return r.move(i)}return t};this.position=function(e){var t=u.stage();if(typeof t!=="undefined"){return t.position()}return undefined};this.export=function(e){var n=u.stage(),r,i;if(typeof n!=="undefined"){i=1;if(e.length>0){i=parseFloat(e[0])}if(e.length>1){r=e[1]}setTimeout(function(){n.export(i,r)},1)}return t};this.options=function(){return n};this.option=function(e){if(e.length>0){if(typeof e[0]==="string"){return n[e[0]]}}return false};this.supports=function(e){if(e.length>0){if(typeof e[0]==="string"){return a[e[0]]}}return false};if(!i.overrideHandlers){(function(r){var i=e("body"),s={x:0,y:0},o=function(){var e=jQuery.Event("ansel-load-file",{canvas:a.canvas,fileapi:a.fileapi});if(!t.val()){return}t.trigger(e);if(e.isDefaultPrevented()){return}if(e.fileapi){(function(){var e=t.get(0).files,n;if(e.length>0){e=e[0];if(e.type.match(/^image\/*/)){n=new FileReader;n.onload=function(){return function(e){u.stage().addImage(e.target.result)}}();n.readAsDataURL(e)}else{alert("Expected image, but received non-image data")}}})()}};onZoom=function(t){var n=.05,r,i=u.stage();if(typeof i==="undefined"){return}if(t.altKey||t.ctrlKey||t.shiftKey){return}if(t.type==="mousewheel"){if(t.originalEvent.wheelDeltaY===undefined){r=t.originalEvent.wheelDelta/120}else{r=t.originalEvent.wheelDeltaY/120}if(t.originalEvent.offsetX!==null){centerZoom={x:t.originalEvent.offsetX,y:t.originalEvent.offsetY};centerZoom=function(t,n){var r=e(t.originalEvent.target).position();n.x+=r.left;n.y+=r.top;return n}(t,centerZoom)}}else{return}t.preventDefault();t.stopPropagation();if(r!==0){i.scale(i.scale()+r*n,centerZoom)}},drag=function(e){var t={x:0,y:0},n={x:0,y:0};e.stopPropagation();e.preventDefault();if(e.type==="mousemove"){t.x=e.screenX;t.y=e.screenY}else if(e.type==="touchmove"){t.x=e.originalEvent.touches[0].screenX;t.y=e.originalEvent.touches[0].screenY}else{return}n.x=t.x-s.x;n.y=t.y-s.y;r.move(n);s=t},startDrag=function(e){if(e.type==="mousedown"&&e.button===0){s={x:e.screenX,y:e.screenY}}else if(e.type==="touchstart"&&e.originalEvent.touches.length===1){s={x:e.originalEvent.touches[0].screenX,y:e.originalEvent.touches[0].screenY}}else{return}e.preventDefault();e.stopPropagation();i.on("mousemove touchmove",drag)};t.on("change",o);$element=e(u.element());if(n.draggable){$element.on("mousedown touchstart",startDrag).css({cursor:"move"});i.on("mouseup mouseleave touchend touchleave",function(e){i.off("mousemove touchmove",drag)})}if(n.zoom){$element.on("mousewheel",onZoom)}o()})(this)}};return new r(i)}();t.data("AnselEditor",r);t.trigger("ansel-initialized");return t}if(n.length>0&&typeof n[0]=="string"){return function(e){var n=e.shift(),i;if(typeof r[n]=="function"){return r[n](e)}return t}(n)}return t}})})(jQuery)}else{console&&console.warn&&console.warn("jQuery Ansel not loaded because jQuery is not detected")};
